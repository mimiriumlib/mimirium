<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <title>å¹½éœŠç—…æ£Ÿ - ã‚¹ã‚¿ãƒ¼ãƒˆ</title>
  <link rel="stylesheet" href="game-mobile.css">
</head>
<body>

  <!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
  <div id="title-screen">
    <img src="assets/yure-image/title-mobile.png" alt="ã‚¿ã‚¤ãƒˆãƒ«ãƒ­ã‚´" class="title-logo">
    <div class="start-buttons">
        <button class="start-button" onclick="startNewGame()">ã¯ã˜ã‚ã‹ã‚‰</button>
        <button class="continue-button" onclick="continueGame()">ã¤ã¥ãã‹ã‚‰</button>
        <button class="start-button" onclick="choiceScene()">ã‚·ãƒ¼ãƒ³é¸æŠ</button>
        <button class="start-button" onclick="openSettings()">ç’°å¢ƒè¨­å®š</button>
    </div>
  </div>

  <audio id="bgm-player" loop></audio>

  <audio id="se-player"></audio>

  <div id="warning">
    <p class="warning-message">
        ã“ã®ã‚µã‚¦ãƒ³ãƒ‰ãƒãƒ™ãƒ«ã¯å…¨å¹´é½¢å¯¾è±¡ã§ã™ãŒã€<br>ç‰©èªã®ä¸­ã«ã¯æš´åŠ›ãƒ»æµè¡€ãªã©ã®æå†™ãŒå«ã¾ã‚Œã¾ã™ã€‚<br>
        ã‚°ãƒ­ãƒ†ã‚¹ã‚¯ãªè¡¨ç¾ãŒè‹¦æ‰‹ãªæ–¹ã¯ã€ã”æ³¨æ„ãã ã•ã„ã€‚
    </p>
  </div>


  <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
  <div id="game-screen" style="display: none;">
    <div id="menu-toggle" onclick="toggleGameMenu()">
      <i id="menu-toggle-icon" class="fas fa-angle-down"></i>
    </div>
    <!-- å±•é–‹ã•ã‚Œã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ -->
<div id="game-menu" style="display: none;">
  <div class="game-menu-list">
    <button onclick="showLog()">ãƒ­ã‚°è¡¨ç¤º</button>
    <button id="auto-mode-button" onclick="toggleAutoMode()">ã‚ªãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼šOFF</button>
    <button onclick="backToTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
  </div>  
</div>
    <div id="game-content">
      <img id="background" class="fullscreen-bg" src="" alt="èƒŒæ™¯">
      <img id="char-left" class="character left" src="" alt="å·¦ã‚­ãƒ£ãƒ©" style="display: none;">
      <img id="char-right" class="character right" src="" alt="å³ã‚­ãƒ£ãƒ©" style="display: none;">
      <div id="choices" style="display: none;"></div>
      <div id="text-window">
        <p id="text-line"></p>
      </div>
    </div>
  </div>

  <!-- ãƒ•ã‚§ãƒ¼ãƒ‰ç”¨ -->
  <div class="fade-out" id="fade"></div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <p id="modal-message"></p>
      <div class="modal-buttons">
        <button id="modal-ok" class="modal-button">OK</button>
        <button id="modal-cancel" class="modal-button" style="display: none;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
      
    </div>
  </div>

  <!-- ç’°å¢ƒè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="settings-modal" class="modal">
    <div class="modal-content">
      <p>éŸ³é‡è¨­å®š</p>
      <label>BGMéŸ³é‡: <input type="range" id="bgm-volume" min="0" max="1" step="0.1"></label><br><br>
      <label>åŠ¹æœéŸ³éŸ³é‡: <input type="range" id="se-volume" min="0" max="1" step="0.1"></label>
      <div class="modal-buttons">
        <button class="modal-button" onclick="closeSettings()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <div id="scene-modal" class="scene-modal-container" style="display: none;">
    <div class="scene-modal-content">
      <h2 class="scene-modal-title">ã‚·ãƒ¼ãƒ³é¸æŠ</h2>
      <p class="scene-modal-description">
        ã‚·ãƒ¼ãƒ³é¸æŠã—ã¦å§‹ã‚ã‚‹ã¨ã€ã¤ã¥ãã‹ã‚‰ã®ãƒšãƒ¼ã‚¸æƒ…å ±ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™
      </p>
      <div class="scene-modal-buttons">
        <button class="scene-modal-button" onclick="selectScene(3)">
          <img src="assets/yure-image/yoru-roka.png" alt="scene3">
          <span>ç¬¬1ç« <br>ã¯ã˜ã¾ã‚Šã®å»Šä¸‹</span>
        </button>
        <button class="scene-modal-button" onclick="selectScene(82)">
          <img src="assets/yure-image/hiru-roka1.png" alt="scene82">
          <span>ç¬¬2ç« <br>æœã®è¨ªã‚Œ</span>
        </button>
        <button class="scene-modal-button" onclick="selectScene(206)">
          <img src="assets/yure-image/hiru-entrance.png" alt="scene206">
          <span>ç¬¬3ç« <br>å‡ºä¼šã„</span>
        </button>
        <button class="scene-modal-button" onclick="selectScene(207)">
          <img src="assets/yure-image/hiru-entrance.png" alt="scene207">
          <span>ç¬¬4ç« <br>çœŸå®Ÿ</span>
        </button>
      </div>
      <button class="scene-modal-close" onclick="closeSceneModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
  
  <div id="log-modal" class="log-modal" style="display: none;">
    <div class="log-header">
      <span>ãƒ­ã‚°</span>
      <button onclick="closeLog()">
        <i class="fas fa-square-xmark" style="font-size: 32px;"></i>
      </button>      
    </div>
    <div id="log-content" class="log-content"></div>
  </div>
  

  <script>

function fadeOut(color = '#000', duration = 1000, callback = null) {
    const fade = document.getElementById('fade');

    // ãƒ•ã‚§ãƒ¼ãƒ‰è‰²ã¨æ™‚é–“ã‚»ãƒƒãƒˆ
    fade.style.backgroundColor = color;
    fade.style.transitionDuration = (duration / 1000) + 's';

    // â˜… å¿…ãšæœ€åˆã«é€æ˜ã«ã™ã‚‹ï¼
    fade.style.opacity = 0;
    fade.classList.add('active');

    // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§é»’ãã™ã‚‹
    requestAnimationFrame(() => {
        fade.style.opacity = 1;
    });

    setTimeout(() => {
      fade.classList.remove('active'); // â˜…ã“ã“è¿½åŠ ï¼æœ€å¾Œã«éè¡¨ç¤º
        fade.style.opacity = 0;           // â˜…é€æ˜ã«æˆ»ã—ã¦æ¬¡ã«å‚™ãˆã‚‹
        if (callback) callback();
    }, duration);
}


function fadeIn(color = '#000', duration = 1000, callback = null) {
    const fade = document.getElementById('fade');

    // æœ€åˆã«ç”»é¢ã‚’çœŸã£é»’ã«ã™ã‚‹
    fade.style.backgroundColor = color;
    fade.style.transitionDuration = (duration / 1000) + 's';
    fade.style.opacity = 1; // é»’ãã—ã¦
    fade.classList.add('active');

    // â˜…ä¸€æ—¦æç”»ã•ã›ã¦ã‹ã‚‰ï¼ˆãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼‰ã€é€æ˜ã«ã™ã‚‹
    setTimeout(() => {
        fade.style.opacity = 0;
    }, 20); // â†ã“ã“ãŒå¤§äº‹ï¼ï¼ˆã»ã‚“ã®å°‘ã—å¾…ã¤ï¼‰

    // é€æ˜ã«ãªã£ãŸã‚‰éè¡¨ç¤ºã«ã™ã‚‹
    setTimeout(() => {
        fade.classList.remove('active');
        fade.style.opacity = 0;
        if (callback) callback();
    }, duration + 20);
}


    let scenarioData = [];
let currentScene = 0;
let currentLine = 0;
let textInterval = null;
let isTyping = false;      // æ–‡å­—ã‚’æç”»ä¸­ã‹ã©ã†ã‹
let logHistory = []; // ãƒ­ã‚°ã‚’è²¯ã‚ã‚‹é…åˆ—
let isSceneAuto = false;      // ã‚·ãƒ¼ãƒ³ã”ã¨ã®è‡ªå‹•ãƒ•ãƒ©ã‚°
let autoTimer = null;         // ã‚ªãƒ¼ãƒˆç”¨ã‚¿ã‚¤ãƒãƒ¼
let autoMode = false;
const bgmPlayer = document.getElementById('bgm-player');  // ã“ã“ã«ç§»å‹•ï¼
bgmPlayer.volume = 0.3;
const sePlayer = document.getElementById('se-player');
sePlayer.volume = 0.4;

// è­¦å‘Šã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯æœ€åˆã«ç™»éŒ²ï¼
document.getElementById('warning').addEventListener('click', function() {
  fadeOut('#000', 1000, function() {
    document.getElementById('warning').style.display = 'none';
    document.getElementById('game-screen').style.display = 'flex';
    startGame();
  });
});


function startGame() {
  fetch('yureibyoto1.json')
    .then(response => response.json())
    .then(data => {
      scenarioData = data;

      // currentScene ã¯ãã®ã¾ã¾ï¼ˆãƒªã‚»ãƒƒãƒˆã—ãªã„ï¼‰
      if (currentScene === null) {  // ã¯ã˜ã‚ã‹ã‚‰ã®å ´åˆã ã‘åˆæœŸåŒ–ï¼
        currentScene = 0;
      }
      currentLine = 0;
      showScene();
      console.log('starsgameï¼ã‚·ãƒ¼ãƒ³:', currentScene);
    });
}


// ã‚·ãƒ¼ãƒ³è¡¨ç¤º
function showScene() {
    console.log('ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸï¼å‰ã‚·ãƒ¼ãƒ³:', currentScene);
  const scene = scenarioData[currentScene];
  const textElement = document.getElementById('text-line');
  textElement.innerHTML = '';

  document.getElementById('choices').innerHTML = '';
  document.getElementById('choices').style.display = 'none';

  // èƒŒæ™¯ç”»åƒ
const baseName = scene.background.replace('.png', '');
document.getElementById('background').src = 'assets/yure-image/' + baseName + '-mobile.png';


  // å·¦ã‚­ãƒ£ãƒ©
  const charLeft = document.getElementById('char-left');
  if (scene.character_left) {
    charLeft.src = 'assets/yure-image/' + scene.character_left;
    charLeft.style.display = 'block';
  } else {
    charLeft.style.display = 'none';
  }

  // å³ã‚­ãƒ£ãƒ©
  const charRight = document.getElementById('char-right');
  if (scene.character_right) {
    charRight.src = 'assets/yure-image/' + scene.character_right;
    charRight.style.display = 'block';
  } else {
    charRight.style.display = 'none';
  }

  // BGMåˆ¶å¾¡
  if (scene.bgm) {
  const basePath = location.origin + location.pathname.replace(/[^/]*$/, '');
  const newBgmSrc = basePath + 'assets/bgm/' + scene.bgm;

  if (bgmPlayer.src !== newBgmSrc) {
    // BGMãŒé•ã†æ™‚ã ã‘åˆ‡ã‚Šæ›¿ãˆ
    bgmPlayer.src = newBgmSrc;
    bgmPlayer.loop = true;
    bgmPlayer.play();
  }
} else {
  // scene.bgm ãŒç©ºã®æ™‚ã ã‘æ­¢ã‚ã‚‹
  bgmPlayer.pause();
  bgmPlayer.src = '';
}


  // SEåˆ¶å¾¡
if (scene.se) {
  sePlayer.src = 'assets/se/' + scene.se;
  sePlayer.play();
}


  // æœ€åˆã®ãƒ†ã‚­ã‚¹ãƒˆè¡Œ
  currentLine = 1;

  // ãƒ†ã‚­ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦è¡¨ç¤ºåˆ‡æ›¿
const textWindow = document.getElementById('text-window');
textWindow.style.display = (scene.window === false) ? 'none' : 'block';

// ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ‡æ›¿
const menuToggle = document.getElementById('menu-toggle');
menuToggle.style.display = (scene.menu === false) ? 'none' : 'block';

  showLine();

  isSceneAuto = !!scene.auto;
  console.log(`ã‚·ãƒ¼ãƒ³ã”ã¨ã®è‡ªå‹•ãƒ•ãƒ©ã‚°ã€€${isSceneAuto}`);
  console.log(`ç¾åœ¨ã®ã‚ªãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã€€${autoMode}`);

if (autoMode && isSceneAuto) {
  console.log(`ã“ã“ã¯é€šã£ã¦ã‚‹ï¼`);
  startAutoScene();
} else {
  stopAutoScene(); // ã„ã£ãŸã‚“åœæ­¢ï¼ˆæ˜ç¤ºçš„ã«ï¼‰
}

  // ã‚·ãƒ¼ãƒ³è¡¨ç¤ºã®æœ€å¾Œã«ã‚»ãƒ¼ãƒ–ï¼
  localStorage.setItem('currentScene', currentScene);
  console.log('ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸï¼ã‚·ãƒ¼ãƒ³:', currentScene);

  playAnimation(scene.post_animation, scene.fade_color, scene.fade_duration);

}

function showLine() {
  const scene = scenarioData[currentScene];
  const line = scene['text' + currentLine];
  const textElement = document.getElementById('text-line');

  if (textInterval) clearInterval(textInterval);

  if (line) {
    const lineElement = document.createElement('p');
    let index = 0;
    isTyping = true;

    textInterval = setInterval(() => {
      lineElement.textContent += line.charAt(index);
      index++;
      if (index >= line.length) {
        clearInterval(textInterval);
        isTyping = false;
      }
    }, 40);
    textElement.appendChild(lineElement); 
  }
  addToLog(line);
  toggleNext(true);
}


function showNextLine() {
  stopAutoScene(); // å‰ã®ã‚ªãƒ¼ãƒˆã‚¿ã‚¤ãƒãƒ¼ã‚’æ­¢ã‚ã‚‹ï¼ˆæ‰‹å‹•ã‚¯ãƒªãƒƒã‚¯å«ã‚€ï¼‰

  currentLine++;
  const scene = scenarioData[currentScene];

  if (scene['text' + currentLine]) {
    showLine();

    // ğŸ”½ ã‚ªãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ãªã‚‰è‡ªå‹•é€ã‚Šã‚’å†é–‹ï¼
    if (isSceneAuto) {
      startAutoScene();
    }

  } else {
    // é¸æŠè‚¢ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if (scene.choice1_text) {
      showChoices(scene);
    } else {
      // æ¬¡ã®ã‚·ãƒ¼ãƒ³
      const nextScene = scenarioData[currentScene + 1];

      if (!nextScene || nextScene.scene_id === "end") {
        showEnding();
        return;
      }

      playAnimation(nextScene.pre_animation, nextScene.fade_color, nextScene.fade_duration, () => {
        currentScene++;
        currentLine = 1;
        showScene();
      });
    }
  }
}


function playSE(fileName) {
  const sePlayer = document.getElementById('se-player');
  sePlayer.src = 'assets/se/' + fileName;  // ãƒ•ã‚¡ã‚¤ãƒ«åã ã‘æ¸¡ã™ï¼
  sePlayer.play();
}

function showWarningAndStart() {
  console.log('è­¦å‘Šæ–‡è¡¨ç¤º');
  document.getElementById('warning').style.display = 'flex';
}

function startNewGame() {
  const savedScene = localStorage.getItem('currentScene');

  if (savedScene !== null) {
    showModal('å‰å›ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦æœ€åˆã‹ã‚‰å§‹ã‚ã¾ã™ã‹ï¼Ÿ', {
  onOk: () => {
    localStorage.removeItem('currentScene');
    currentScene = 0;
    startNewGame(); // å†ã‚¹ã‚¿ãƒ¼ãƒˆ
  },
  onCancel: () => {
    console.log('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
  }
});

  } else {
    proceedNewGame();  // ãƒ‡ãƒ¼ã‚¿ãŒç„¡ã‘ã‚Œã°ã™ãé–‹å§‹
  }
}

// å®Ÿéš›ã®ã‚²ãƒ¼ãƒ é–‹å§‹å‡¦ç†
function proceedNewGame() {
  playSE('ok.mp3');

  // ã¾ãšfadeOutï¼ˆé€æ˜â†’é»’ï¼‰
  fadeOut('#000', 1000, function() {
    // fadeOutå®Œäº†å¾Œã«ã€ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ¶ˆã—ã¦è­¦å‘Šæ–‡ã‚’å‡ºã™æº–å‚™
    document.getElementById('title-screen').style.display = 'none';
    showWarningAndStart();
    // ãã—ã¦fadeInï¼ˆé»’â†’é€æ˜ï¼‰
    fadeIn('#000', 1000, function() {
    });
  });
}

function continueGame() {
    console.log('continueGameå®Ÿè¡Œ');

  const savedScene = localStorage.getItem('currentScene');
  if (savedScene !== null) {
    currentScene = parseInt(savedScene);
    currentLine = 0;
    playSE('ok.mp3');
    fadeOut('#000', 1000, function() {
      document.getElementById('title-screen').style.display = 'none';
      document.getElementById('game-screen').style.display = 'flex';
      startGame();
    });
  } else {
    showModal('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');

  }
}

function showModal(message, options = {}) {
  const modal = document.getElementById('modal');
  const modalMessage = document.getElementById('modal-message');
  const okButton = document.getElementById('modal-ok');
  const cancelButton = document.getElementById('modal-cancel');

  modalMessage.innerHTML = message;
  modal.style.display = 'flex';

  // OKãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
  okButton.onclick = () => {
    modal.style.display = 'none';
    if (options.onOk) options.onOk();
  };

  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
  if (options.onCancel) {
    cancelButton.style.display = 'inline-block';
    cancelButton.onclick = () => {
      modal.style.display = 'none';
      options.onCancel();
    };
  } else {
    cancelButton.style.display = 'none';  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãªã—ã®ã¨ã
  }
}

function openSettings() {
  document.getElementById('settings-modal').style.display = 'flex';

  // ç¾åœ¨ã®éŸ³é‡ã‚’ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã«åæ˜ 
  document.getElementById('bgm-volume').value = bgmPlayer.volume;
  document.getElementById('se-volume').value = sePlayer.volume;
}

function closeSettings() {
  document.getElementById('settings-modal').style.display = 'none';
}

// é¸æŠè‚¢è¡¨ç¤ºå‡¦ç†
function showChoices(scene) {
    toggleNext(false);
  const choicesDiv = document.getElementById('choices');
  choicesDiv.innerHTML = '';  // å‰ã®é¸æŠè‚¢ã‚¯ãƒªã‚¢

  let hasChoice = false;
  for (let i = 1; i <= 3; i++) {
    const text = scene[`choice${i}_text`];
    const jump = scene[`choice${i}_jump`];

    if (text) {
      const button = document.createElement('button');
      button.classList.add('choice-button');
      button.textContent = text;
      button.addEventListener('click', () => {
        currentScene = jump - 1;
        currentLine = 1;
        toggleNext(true);
        showScene();
      });
      choicesDiv.appendChild(button);
      hasChoice = true;
    }
  }
  choicesDiv.style.display = hasChoice ? 'flex' : 'none';
}

// ğŸ”· ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã™ã‚‹ï¼ˆé–¢æ•°ã®å¤–ã«ç½®ãï¼ï¼‰
function advanceHandler() {
  if (isTyping) {
    skipTyping();
  } else {
    showNextLine();
  }
}

function keyHandler(e) {
  if (e.key === 'Enter') {
    advanceHandler();
  }
}

function toggleNext(enable) {
  const gameContent = document.getElementById('game-content');

  if (enable) {
    gameContent.addEventListener('click', advanceHandler);
    document.addEventListener('keydown', keyHandler);
  } else {
    gameContent.removeEventListener('click', advanceHandler);
    document.removeEventListener('keydown', keyHandler);
  }
}



function shakeBackground(duration = 400, callback = null) {
    const background = document.getElementById('background');
    if (!background) {
        if (callback) callback();
        return;
    }

    background.classList.add('shake');

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒçµ‚ã‚ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚¯ãƒ©ã‚¹ã‚’å¤–ã—ã¦ callback
    setTimeout(() => {
        background.classList.remove('shake');
        if (callback) callback();
    }, duration);
}

function playAnimation(type, color, duration, callback) {
    if (!type) {
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç„¡ã—ãªã‚‰ãã®ã¾ã¾æ¬¡ã¸
        if (callback) callback();
        return;
    }

    switch(type) {
        case 'fadeOut':
            fadeOut(color, duration, callback);
            break;
        case 'fadeIn':
            fadeIn(color, duration, callback);
            break;
        case 'shake':
            shakeBackground(duration, callback);
            break;
        default:
            console.warn('æœªå¯¾å¿œã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: ' + type);
            if (callback) callback();
            break;
    }
}

function choiceScene() {
  document.getElementById('scene-modal').style.display = 'flex';
}

function closeSceneModal() {
  document.getElementById('scene-modal').style.display = 'none';
}

function selectScene(sceneNumber) {
  console.log(`ã‚·ãƒ¼ãƒ³${sceneNumber}ã‚’é¸æŠ`);
  localStorage.setItem('currentScene', sceneNumber);
  closeSceneModal();
  continueGame();
}


function toggleGameMenu() {
  const menu = document.getElementById('game-menu');
  const toggle = document.getElementById('menu-toggle');
  const icon = document.getElementById('menu-toggle-icon');
  const isVisible = menu.style.display === 'block';

  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºåˆ‡æ›¿
  menu.style.display = isVisible ? 'none' : 'block';

  // ã‚¢ã‚¤ã‚³ãƒ³åˆ‡ã‚Šæ›¿ãˆ
  icon.className = isVisible ? 'fas fa-angle-down' : 'fas fa-angle-up';
}

function backToTitle() {
  showModal('ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ<br><br>ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã«æˆ»ã‚‹å ´åˆã€<br>ã€Œã¤ã¥ãã‹ã‚‰ã€ã‚’é¸æŠã™ã‚‹ã¨<br>åŒã˜ã‚·ãƒ¼ãƒ³ã«æˆ»ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚', {
    onOk: () => {
      location.reload(); // â† ã“ã“ã‚’ fadeOut ã—ã¦æˆ»ã‚‹ãªã©ã«å¤‰ãˆã¦ã‚‚OK
    },
    onCancel: () => {
      console.log('ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
    }
  });
}

function toggleAutoMode() {
  autoMode = !autoMode;
  document.getElementById('auto-mode-status').textContent = autoMode ? 'ON' : 'OFF';

  if (autoMode) {
    startAutoMode();
  } else {
    stopAutoMode();
  }
}

function addToLog(text) {
  if (text.trim()) {
    logHistory.push(text);
  }
}

function showLog() {
  const logModal = document.getElementById('log-modal');
  const logContent = document.getElementById('log-content');

  // ãƒ­ã‚°ã‚’ã™ã¹ã¦åæ˜ 
  logContent.innerHTML = logHistory.map(line => `<div>${line}</div>`).join('');

  // ä¸€ç•ªä¸‹ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  setTimeout(() => {
    logContent.scrollTop = logContent.scrollHeight;
  }, 0);

  logModal.style.display = 'flex';
}

function closeLog() {
  document.getElementById('log-modal').style.display = 'none';
}

function startAutoScene() {
  stopAutoScene(); // å¿µã®ãŸã‚æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’æ¶ˆã™
  console.log(`ã‚ªãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã€€${autoMode}`);

  if (!autoMode) return;

  autoTimer = setInterval(() => {
    showNextLine();
  }, 3000); // ä¾‹ï¼š2.5ç§’ã”ã¨ã«æ¬¡ã®ã‚»ãƒªãƒ•ã¸
}

function stopAutoScene() {
  if (autoTimer) {
    clearInterval(autoTimer);
    autoTimer = null;
  }
}

function toggleAutoMode() {
  const btn = document.getElementById('auto-mode-button');

  if (!autoMode) {
    // ã‚ªãƒ¼ãƒˆON
    autoMode = true;
    btn.textContent = 'ã‚ªãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼šON';
    startAutoScene();
  } else {
    // ã‚ªãƒ¼ãƒˆOFF
    autoMode = false;
    btn.textContent = 'ã‚ªãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼šOFF';
    stopAutoScene();
  }
}

function skipTyping() {
  const scene = scenarioData[currentScene];
  const line = scene['text' + currentLine];

  clearInterval(textInterval);
  textInterval = null;
  isTyping = false;

  // æœ€å¾Œã® <p> è¦ç´ ã«å…¨æ–‡ã‚’ä¸Šæ›¸ãã™ã‚‹
  const lastP = document.querySelector('#text-line p:last-child');
  if (lastP) {
    lastP.textContent = line;
  }
}

function skipTyping() {
  const scene = scenarioData[currentScene];
  const line = scene['text' + currentLine];

  clearInterval(textInterval);
  textInterval = null;
  isTyping = false;

  // æœ€å¾Œã® <p> è¦ç´ ã«å…¨æ–‡ã‚’ä¸Šæ›¸ãã™ã‚‹
  const lastP = document.querySelector('#text-line p:last-child');
  if (lastP) {
    lastP.textContent = line;
  }
}

function showEnding() {
  // ã‚²ãƒ¼ãƒ ç”»é¢ã‚’éè¡¨ç¤ºã«ã—ã¦æ“ä½œã‚‚ç„¡åŠ¹åŒ–
  document.getElementById('game-screen').style.display = 'none';
  toggleNext(false);

  // é»’èƒŒæ™¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ä½œæˆ
  const overlay = document.createElement('div');
  overlay.id = 'ending-overlay';
  document.body.appendChild(overlay);

  // ãƒ†ã‚­ã‚¹ãƒˆç”¨è¦ç´ ã‚’å¸¸é§ã•ã›ã¦è¿½åŠ ï¼ˆå†åˆ©ç”¨ã™ã‚‹ï¼‰
  const textElement = document.createElement('p');
  textElement.className = 'ending-text';
  overlay.appendChild(textElement);

  // é»’èƒŒæ™¯ã‚’ã˜ã‚ã£ã¨è¡¨ç¤ºï¼ˆoverlayè‡ªä½“ï¼‰
  setTimeout(() => {
    overlay.style.opacity = '1';
  }, 100);

  const messages = [
  'å¹½éœŠç—…æ£Ÿ   Chapter 1',
  'Audio<br>DOVA-SYNDROME / åŠ¹æœéŸ³ãƒ©ãƒœ / ç„¡æ–™åŠ¹æœéŸ³ã§éŠã¼ã†ï¼',
  'Script & Backgrounds<br>Powered by OpenAI',
  'Â©MIMIRIUM'
  ];

  let index = 0;

  function showMessage() {
    if (index < messages.length) {
      textElement.innerHTML = messages[index];
      textElement.classList.remove('ending-fade-out');
      textElement.classList.remove('ending-fade-in');

      // å†æç”»å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã•ã›ã‚‹
      requestAnimationFrame(() => {
        textElement.classList.add('ending-fade-in');
      });

      // ä¸€å®šæ™‚é–“è¡¨ç¤º â†’ ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ â†’ æ¬¡ã¸
      setTimeout(() => {
        textElement.classList.remove('ending-fade-in');
        textElement.classList.add('ending-fade-out');


        setTimeout(() => {
          textElement.textContent = '';
          index++;
          showMessage();
        }, 1000); // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆæ™‚é–“
      }, 2000); // è¡¨ç¤ºæ™‚é–“
    } else {
      // æœ€å¾Œã¯ To be Continue ã‚’è¡¨ç¤º
      overlay.innerHTML = `<p class="ending-continue">To be continuedâ€¦</p>`;
      overlay.style.pointerEvents = 'auto';

      overlay.onclick = () => {
  location.reload();
};
    }
  }

  setTimeout(() => {
    showMessage();
  }, 1600); // é»’ãƒ•ã‚§ãƒ¼ãƒ‰å¾Œã«1æ–‡ç›®è¡¨ç¤º
}




// éŸ³é‡å¤‰æ›´æ™‚ã®å‡¦ç†
document.getElementById('bgm-volume').addEventListener('input', function() {
  bgmPlayer.volume = parseFloat(this.value);
});
document.getElementById('se-volume').addEventListener('input', function() {
  sePlayer.volume = parseFloat(this.value);
});

window.addEventListener('load', function() {
    window.scrollTo(0, 0);
});


  </script>

</body>
</html>
